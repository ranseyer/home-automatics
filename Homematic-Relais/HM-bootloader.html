<html>
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/></head>
<body>
<form id="form" name="bl" action=""> <div style="margin-bottom: 20px;">Bootloader: <input type="file" name="file" id="file" accept=".hex"></div>
 <div style="margin-bottom: 20px;">Select Device: 
   <select name="DevID">
     <option value="0002">HM Relay Board - 1 Relay</option>
     <option value="000a">HM Relay Board - 2 Relay</option>
     <option value="0003">HM Relay Board - 4 Relay</option>
   </select>
 </div>
 <div style="margin-bottom: 20px;">Enter HM ID - a 6 digit hex number: 
 <input type="text"  name="HmID" value="0A0301" size="6" pattern="[0-9A-F]{6}" maxlength="6"/></div>
 <div>Enter HM-Serial like "HMRy000000" <br/>all '0' can be replaced by any number or character</div>

 <div style="margin-bottom: 20px;">
 HMRy<input type="text"  name="Serial" value="000001" size="10" pattern="[0-9A-Za-z]{6}" maxlength="6"/>
 </div>
 <div><button type="button" id="create">Create</button></div> <div id="forsave"/>
</form>
</body>
<script language="javascript" type="text/javascript">
function ascii_to_hexa(str) {    var arr1 = [];    for (var n = 0, l = str.length; n < l; n ++) {      var hex = ('00' + Number(str.charCodeAt(n)).toString(16)).slice(-2).toUpperCase();      arr1.push(hex);    }    return arr1.join('');  }  
function checksum (str) {  var sum = 0;  for (var n = 1, l = str.length; n < l; n += 2 )    {    var num = str.charAt(n) + str.charAt(n+1);    var s = parseInt(num,16);    sum += s;  }  sum = 256 - (sum % 256);  return ('00' + sum.toString(16)).slice(-2).toUpperCase();}
function patchbl() {  var form = document.getElementById('form');  var file = document.getElementById('file').files[0];  if( typeof file === 'undefined' ) {    alert('Please select Bootloader HEX file');	return;  }
  var devid = form.DevID.value.toUpperCase();  var hmid = form.HmID.value.toUpperCase();  var serial = "HMRy" + form.Serial.value;
  var div = document.getElementById('forsave');  var fc = div.firstChild;  while( fc ) {    div.removeChild(fc);	fc = div.firstChild;  }
  var reader = new FileReader();  reader.onload = function(progressEvent){    // By lines    var lines = this.result.split('\n');    for(var line = 0; line < lines.length; line++){      var block = lines[line];	  if( block.startsWith(':027FF000') ) { // DEVID	    block = ':027FF000' + devid;	    lines[line] = block + checksum(block) + '\n';	  }	  else if( block.startsWith(':037FFC00') ) { // HMID	    block = ':037FFC00' + hmid;	    lines[line] = block + checksum(block) + '\n';	  }	  else if( block.startsWith(':0A7FF200') ) { // SERIAL	    block = ':0A7FF200' + ascii_to_hexa(serial);	    lines[line] = block + checksum(block) + '\n';	  }	  else {	    lines[line] = block + '\n';	  }    }    var blob = new Blob(lines,{ type : 'text/plain'});    var a = document.createElement('a');    a.download=serial + '.hex';    a.href = window.URL.createObjectURL(blob);    a.textContent = 'Save Bootloader';    div.appendChild(a);  };  reader.readAsText(file);}

var create = document.getElementById('create');
create.addEventListener('click',patchbl,true);

</script> 

</html>
